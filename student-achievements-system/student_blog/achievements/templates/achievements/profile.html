{% extends 'achievements/base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <!-- Profile Header -->
    <div class="card" style="background: var(--gradient-secondary); color: white; margin-bottom: 2rem;">
        <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
            <div style="width: 120px; height: 120px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: var(--accent-purple); border: 4px solid white; box-shadow: var(--shadow-lg);">
                {% if profile.avatar %}
                <img src="{{ profile.avatar.url }}" alt="{{ user.get_full_name }}" 
                     style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                {% else %}
                {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                {% endif %}
            </div>
            <div style="flex: 1;">
                <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">{{ user.get_full_name|default:user.username }}</h1>
                <p style="font-size: 1.2rem; opacity: 0.9; margin-bottom: 0.5rem;">
                    <i class="fas fa-id-card"></i> {{ profile.roll_number|default:"No roll number" }}
                </p>
                <p style="opacity: 0.8;">
                    <i class="fas fa-building"></i> {{ profile.department|default:"Computer Science & Engineering" }} â€¢ Year {{ profile.year|default:"2025" }}
                </p>
            </div>
        </div>
    </div>

    <div class="grid grid-2" style="gap: 2rem;">
        <!-- Profile Stats -->
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-dark);">
                <i class="fas fa-chart-bar"></i> Profile Statistics
            </h2>
            
            <div class="grid grid-2" style="gap: 1rem; margin-bottom: 2rem;">
                <div class="text-center" style="padding: 1.5rem; background: #f0f9ff; border-radius: 10px; border: 1px solid #e0f2fe;">
                    <i class="fas fa-trophy fa-2x" style="color: var(--primary-blue); margin-bottom: 0.5rem;"></i>
                    <h3 style="color: var(--text-dark); margin-bottom: 0.25rem;">{{ total_achievements }}</h3>
                    <p style="color: var(--text-light); font-size: 0.9rem;">Total Achievements</p>
                </div>
                <div class="text-center" style="padding: 1.5rem; background: #f0fdf4; border-radius: 10px; border: 1px solid #dcfce7;">
                    <i class="fas fa-check-circle fa-2x" style="color: #10b981; margin-bottom: 0.5rem;"></i>
                    <h3 style="color: var(--text-dark); margin-bottom: 0.25rem;">{{ approved_achievements }}</h3>
                    <p style="color: var(--text-light); font-size: 0.9rem;">Approved</p>
                </div>
            </div>

            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 10px; border: 1px solid #e2e8f0;">
                <h4 style="color: var(--text-dark); margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i> Profile Completion
                </h4>
                <div style="background: #e2e8f0; height: 8px; border-radius: 4px; margin-bottom: 0.5rem;">
                    <div style="background: var(--gradient-primary); height: 100%; border-radius: 4px; width: 85%;"></div>
                </div>
                <p style="color: var(--text-light); font-size: 0.9rem;">85% Complete</p>
            </div>

            <!-- Quick Actions -->
            <div style="margin-top: 2rem;">
                <h4 style="color: var(--text-dark); margin-bottom: 1rem;">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h4>
                <div style="display: grid; gap: 0.75rem;">
                    <a href="{% url 'dashboard' %}" class="btn" style="justify-content: start; gap: 1rem;">
                        <i class="fas fa-plus-circle"></i> Add New Achievement
                    </a>
                    <a href="{% url 'achievements' %}" class="btn btn-secondary" style="justify-content: start; gap: 1rem;">
                        <i class="fas fa-trophy"></i> View All Achievements
                    </a>
                </div>
            </div>
        </div>

        <!-- Edit Profile Form -->
        <div class="card">
            <h2 style="margin-bottom: 1.5rem; color: var(--text-dark);">
                <i class="fas fa-user-edit"></i> Edit Profile
            </h2>

            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}error{% else %}success{% endif %}" style="margin-bottom: 1.5rem;">
                <i class="fas fa-{% if message.tags == 'error' %}exclamation-circle{% else %}check-circle{% endif %}"></i>
                {{ message }}
            </div>
            {% endfor %}
            {% endif %}

            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="id_roll_number"><i class="fas fa-id-card"></i> Roll Number *</label>
                    {{ form.roll_number }}
                    {% if form.roll_number.errors %}
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ form.roll_number.errors.0 }}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="id_department"><i class="fas fa-building"></i> Department *</label>
                    {{ form.department }}
                    {% if form.department.errors %}
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ form.department.errors.0 }}
                    </div>
                    {% endif %}
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="id_year"><i class="fas fa-calendar"></i> Year *</label>
                        {{ form.year }}
                        {% if form.year.errors %}
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i>
                            {{ form.year.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="id_phone"><i class="fas fa-phone"></i> Phone</label>
                        {{ form.phone }}
                    </div>
                </div>

                <div class="form-group">
                    <label for="id_avatar"><i class="fas fa-camera"></i> Profile Picture</label>
                    {{ form.avatar }}
                    {% if profile.avatar %}
                    <div style="margin-top: 0.5rem;">
                        <small style="color: var(--text-light);">Current: {{ profile.avatar.name }}</small>
                    </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="id_bio"><i class="fas fa-file-alt"></i> Bio</label>
                    {{ form.bio }}
                    <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                        Tell us about yourself, your interests, and career goals
                    </small>
                </div>

                <button type="submit" class="btn" style="width: 100%;">
                    <i class="fas fa-save"></i> Update Profile
                </button>
            </form>
        </div>
    </div>

<!-- Recent Achievements -->
<div class="card" style="margin-top: 2rem;">
    <h2 style="margin-bottom: 1.5rem; color: var(--text-dark);">
        <i class="fas fa-history"></i> Recent Achievements
    </h2>
    
    {% if user.achievements.all %}
    <div class="achievement-grid">
        {% for achievement in user.achievements.all|slice:":4" %}
        <div class="achievement-card">
            <!-- Achievement Image -->
            {% if achievement.get_image_url %}
                <img src="{{ achievement.get_image_url }}" alt="{{ achievement.name }}" class="achievement-image">
            {% else %}
                <div style="background: var(--gradient-primary); height: 200px; display: flex; align-items: center; justify-content: center; color: white;">
                    <i class="fas fa-trophy fa-3x"></i>
                </div>
            {% endif %}
            
            <div class="achievement-content">
                <h4>{{ achievement.name }}</h4>
                <div class="achievement-meta">
                    <span class="meta-tag">{{ achievement.event }}</span>
                    <span class="meta-tag" style="background: #fef3c7; color: #d97706;">
                        {{ achievement.prize }}
                    </span>
                </div>
                <div style="margin-top: 1rem;">
                    <small style="color: var(--text-light);">
                        {{ achievement.date_achieved|date:"M d, Y" }}
                    </small>
                    {% if achievement.is_approved %}
                    <span class="meta-tag" style="background: #ecfdf5; color: #065f46; float: right;">
                        <i class="fas fa-check"></i> Approved
                    </span>
                    {% else %}
                    <span class="meta-tag" style="background: #fef3c7; color: #d97706; float: right;">
                        <i class="fas fa-clock"></i> Pending
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    {% if user.achievements.all|length > 4 %}
    <div class="text-center" style="margin-top: 2rem;">
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">
            <i class="fas fa-eye"></i> View All Achievements
        </a>
    </div>
    {% endif %}
    
    {% else %}
    <div class="text-center" style="padding: 3rem 2rem; color: var(--text-light);">
        <i class="fas fa-trophy fa-3x" style="margin-bottom: 1rem; opacity: 0.5;"></i>
        <h3>No Achievements Yet</h3>
        <p>Start showcasing your success stories!</p>
        <a href="{% url 'dashboard' %}" class="btn" style="margin-top: 1rem;">
            <i class="fas fa-plus"></i> Add Your First Achievement
        </a>
    </div>
    {% endif %}
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add form control classes
    const formControls = document.querySelectorAll('input, textarea, select');
    formControls.forEach(control => {
        if (!control.classList.contains('form-control')) {
            control.classList.add('form-control');
        }
    });

    // Auto-expand bio textarea
    const bioTextarea = document.getElementById('id_bio');
    if (bioTextarea) {
        bioTextarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // Trigger initial resize
        bioTextarea.style.height = 'auto';
        bioTextarea.style.height = (bioTextarea.scrollHeight) + 'px';
    }

    // Preview avatar image
    const avatarInput = document.getElementById('id_avatar');
    if (avatarInput) {
        avatarInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // You can add avatar preview functionality here
                    console.log('New avatar selected:', file.name);
                    // Optionally update the avatar preview image
                    const avatarPreview = document.querySelector('.card img[alt*="{{ user.get_full_name }}"]');
                    if (avatarPreview) {
                        avatarPreview.src = e.target.result;
                    }
                }
                reader.readAsDataURL(file);
            }
        });
    }
});
</script>
{% endblock %}